---
title: "MSstatsQC User Manual"
author: "Eralp DOGU, Sara TAHERI, Olga VITEK"
date: "May 18, 2016"
output:
  html_document:
    toc: yes
  pdf_document:
    number_sections: yes
    toc: yes
bibliography: library.bib
---

# Longitudinal system suitability monitoring tools for quantitative mass spectrometry based proteomic experiments

The increasing need for defining good quality measurement and analyzing traceable critical quality metrics has been guiding proteomics society to focus more on system suitability analysis and discovering quantitative tools/protocols [@Rudnick2009; @Abbatiello2013; @Abbatiello2015]. Moreover, systematic longitudinal system suitability monitoring approaches are desirable to evaluate critical-to-quality measures and present most informative QC metrics over time [@Ma2012; @Taylor2013; @Pichler2012; @Bereman2014]. 
`MSstatsQC` is an open-source R-based web application for statistical analysis and monitoring of quality control (QC) and system suitability testing (SST) samples produced by spectrometry-based proteomic experiments. This document describes `MSstatsQC`, the most recent version of the application, and its use through the user interface. 

## Applicability
`MSstats` v1.0 and above is applicable to multiple types of workflows. It is applicable to targeted Selected Reaction Monitoring (SRM), Data-Dependent Acquisition (DDA or shotgun), and Data-Independent Acquisition (DIA or SWATH-MS) where QC and SST samples are analyzed based on targeted MS/MS acquisition. 

## Statistical functionalities

Statistical process control (SPC) is a well-established method of QC which is applied to monitor and improve the quality of a process and intergrated to `MSstatsQC`. This manual essentially introduces simultaneous and time weighted monitoring tools and change point analysis for metric-wise and precursor-wise mean and dispersion. Proposed longitudinal monitoring approach significantly improves the ability of early detection and prevention of chromatographic and instrumental problems with real-time monitoring of LC-MS/MS performance during assay development and implementation, therefore, reduces cost of control and failure. 

Our approach presents alternative methods of monitoring such as time weighted control charts to ensure that various types of process disturbances are detected effectively. Simultaneous control charts used in this framework can be classified into two groups: *individual-moving range (XmR) control charts* and *mean and dispersion cumulative sum (CUSUM) control charts*. Experiment specific control limits are provided with the control charts to distinguish between random noise and systematic error. LC-MS/MS process disruptions can occur in various ways such as large shifts or slow drifts of metric mean and/or variation. 

The QC or SST sample at which a signal is issued is considered as an evidence of nonrandom process behaviour and treated as an *out-of-control* observation. After this signal, process professionals start searching for assignable cause(s). However, the signal does not always designate that the special cause actually occurred at that certain acquisition time. A remedy to this problem is to use follow-up *change point analysis* along with control charts. Change point estimation procedures have a potential to save time by narrowing the search window for special causes. In this framework, we introduce two change point models: *step shift change model for mean* and *step shift change model for variance*. 

## Interoperability with existing computational tools

`MSstatsQC` takes as input QC data in a tabular .csv format (Figure 1), which can be generated by any spectral processing tool. `MSstatsQC` v1.0 and above is available as an external tool and compatible with Skyline [@MacLean2010] and PanoramaWeb [@Sharma2014] reports. 


## Availability

`MSstatsQC` is available under the Artistic-2.0 license at [msstatsqc.shiny.io/msstatsqc](msstats.org/msstatsqc). We suggest to use that version if possible. The versioning of the main application is updated several times a year, to synchronise with the most recent developments.


## Overview of the functionalities


## Troubleshooting

To help troubleshoot potential problems with installation or functionalities of `MSstatsQC`, a progress report is generated in a separate log file *msstatsqc.log*. The file includes information on the R session (R version, loaded software libraries), options selected by the user, checks of successful completion of intermediate analysis steps, and warning messages. If the analysis produces an error, the file contains suggestions for possible reasons for the errors. If a file with this name already exists in working directory, a suffix with a number will be appended to the file name. In this way a record of all the analyses is kept. Please see the file `KnownIssues-MSstatsQC-V1.0.pdf` on the "Help" page of `msstatsqc/shiny.io/msstatsqc` for a list of known issues and possible solutions for problems you might face using `MSstatsQC`.

# Allowable data format: 7-column format 

`MSstats` performs statistical analysis, to monitor LC-MS/MS process performance by tracking system suitability metrics including total peak area, retention time reproducibility, full width at half maximum (FWHM) and peak asymmetry.  Therefore, input to `MSstatsQC` is the output of other software tools (such as Skyline or MultiQuant) that read raw spectral files and report system suitability metrics. The preferred structure of data for use in `MSstatsQC` is  a .csv file in a "long" format with 7 columns representing the following variables: `AcquiredTime`, `PrecursorName`, `BestRetentionTime`, `TotalArea`, `MaxFWHM`, `MaxEndTime`, and `MinStartTime`.  The variable names are fixed, but are case-insensitive. This required input data is generated automatically if the report format is defined in Skyline.

(a) `AcquiredTime`: This column shows the acquired time of the QC/SST sample in the format of MM/DD/YYYY HH:MM:SS AM/PM
(b) `PrecursorName`: This column needs information about Precursor id. Statistical analysis will be done separately for each unique label in this column. 

(c)-(f) `BestRetentionTime`, `TotalArea`, `MaxFWHM`, `MaxEndTime`, and `MinStartTime`: The combination of these 5 columns defines a *feature* of a peak for a specific peptide. If the information for one or several of these columns is not available, please do not discard these columns but use a single fixed value across the entire dataset. For example, if the original raw data does not contain the information of `TotalArea`, assign the value NaN to the entries in the column `TotalArea` for the entire dataset. 

An example of an acceptable input dataset is shown below. This example dataset is from a system suitability testing stidy from CPTAC Study 9.1. The dataset is stored in a .csv file in a "long" format.  Each row corresponds to a single QC sample. 

![MSstatsQC Data Format](/Users/ed/Dropbox/MSstatsQC/UserManual/7columnDataFormat.png)

## Uploading QC Data and 'Data Import' Tab
 
A QC or SST dataset which is in the allowable data format is uploaded via `Data Import` tab. Please follow the steps below to upload your data.

(a) Click `Choose file` 
(b) Select and upload the file you want to analyze
 
### Chosing a Guide Set 

Generally, a data gathering and parameter estimation step is applied to characterize the in-control parameters of a given QC metric for a specific peptide. Within that phase, control limits are obtained to test the hypothesis of statistical control. These thresholds are selected to ensure a specified type I error rate. Constructing control charts and real time evaluation are considered after achieving this phase. Along with the implementation, the operators should follow signals given by the control charts. Each signal and non-random pattern should be examined carefully to identify the special causes of variation in metric mean and dispersion. Many control charts are designed with the assumption of data availability to estimate the process parameters. Therefore, control limits are assumed to be available before on-line control begins.

Please select a proper and representative guide set using `Data Import` tab. The lower bound of guide set indicates the index of the first QC sample to be included in the guide set. For example, if you choose "1" as a lower bound, it means that first QC sample will be the first element of the guide set. Similarly, upper bound of guide set shows the index for the last observation. It is possible to use different guide sets for different suitability metrics and precursors. 

After choosing a guide set, the user can select the precursor of interest or select all to generate a k by 2 matrix of control charts where k is the number of precursors. A mean and a dispersion control chart are generated for each precursor after clicking `Click to see plots` button.

# 'Metric Summary' Panel

The aim of the metric summary panel is to summarize each system suitability metric with the elution order of peptides. The boxplot tab shows boxplots for each metric. The user can investigate these charts to see if any abrubt observations are present in the dataset. If so, we recommend a preprocessing for the dataset and re-uploading it for better results. Metric summary panel also provides scatter plot matrices for each metric to show interrelations among the peptides for a specific metric.

![Metric Summary-Boxplot](/Users/ed/Dropbox/MSstatsQC/UserManual/Summarytab.png)

![Metric Summary-Scatter Plot Matrix](/Users/ed/Dropbox/MSstatsQC/UserManual/Summarytab.png)

# 'Control Charts' Panel

All control charts are generated in this tab. The drop-down menu shows the alternative control charts. `XmR` and `CUSUM` charts are available options for `MSstatsQC` v1.0. If you select `XmR` or `CUSUM`, then you will obtain a mean (right hand side) and a dispersion (left hand side) control chart for each peptide. Each control chart has limits shown in red and the relevant statistics are plotted accordingly. Any observation which exceeds the thresholds are considered as a `out-of-control` point and shown in red. All the plots generated to be interactive. The user can move the cursor the the point of interest to see the original value and QC number of each observation. Additionally, the user can zoom in or out and save the plots to use in their QC/SST reports.

## 'XmR' Control Charts

This tab shows `X` and `mR` control charts for each precursor. An example for Study 9.1 is presented in Figure 2. By using the sequential differences between two successive values as a measure of dispersion, a chart for individual observations (X chart) and a chart for moving ranges (mR chart) or XmR chart can be created.  The original observations are plotted on a X chart along with upper and lower control limits. Here, design parameters are particularly chosen to provide a type I error rate of 0.0027 which guarantees the well-known 3$\sigma$ limits. Moving ranges are plotted on a mR chart along with their corresponding upper and lower control limits. Any point above or below the control limits are classified as out-of-control observations and need special attention as they might provide valuable information about chromatographic and instrumental problems.

![XmR Control Chart](/Users/ed/Dropbox/MSstatsQC/UserManual/XmRchart.png)

## 'CUSUM' Control Charts

This tab shows `CUSUMm` and `CUSUMv` control charts for each precursor. An example for Study 9.1 is presented in Figure 3. Mean and dispersion CUSUM charts both have more complex design parameters when compared to XmR charts. However, they have proven ability to detect small shifts earlier. In order to simplify design complexity we consider standardized metrics. For our case, CUSUMm essentially is a tabular CUSUM with the standardized QC observations and sensitive to changes in metric mean. Basically, CUSUMm plots two types of CUSUM statistics; one for positive mean shifts and the other for negative mean shifts. Standardization enables informal benchmarking among different metrics and reduce design complexity into a considerably simple level. It is also possible to construct a variability or scale CUSUM called a CUSUMv charts with the following approach to monitor the precision performance of the instrument. 

![CUSUM Control Chart](/Users/ed/Dropbox/MSstatsQC/UserManual/Cusumchart.png)

# 'Change Point Analysis' Panel

This tab shows change point analysis for a mean shift and change point analysis for a dispersion shift for each precursor. An example for Study 9.1 is presented in Figure 4. The first change point model considers a step change in the mean level of a suitability metric. The change point estimator is the value which maximizes the change point function for process mean. Change point formulation for dispersion follows a similar approach using a change point function for process dispersion. The red horizantal lines show the change point estimate which maximizes the change point function.

![Change Point Analysis](/Users/ed/Dropbox/MSstatsQC/UserManual/Cusumchart.png)

# 'Help' Panel

The aim of this panel is to help user get information about the system suitability metrics and control charts used in `MSstatsQC`. Examples subpanel provides a sample dataset and results for this dataset. Help panel also includes a troubleshoting subpanel where the user can see possible patterns in a system suitability monitoring report and possible root causes of these patterns.

***
# References


